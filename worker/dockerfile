# Stage 1: Build - Use the SDK image for compiling and packaging.
# Using '7.0' as the target framework is 'net7.0'
FROM mcr.microsoft.com/dotnet/sdk:7.0 AS build
WORKDIR /src/worker

# Copy the project file first to restore dependencies and leverage Docker layer caching
COPY worker/Worker.csproj .
RUN dotnet restore 

# Copy the remaining source code
COPY worker/ .

# Stage 2: Publish - Create the release build artifacts.
# This ensures that only the necessary, optimized binaries are used later.
FROM build AS publish
RUN dotnet publish -c Release -o /app/publish --no-restore


# Stage 3: Final - Use the minimal Runtime image for execution.
# Using a minimal base (like Alpine) and switching to a non-root user is a security best practice.
FROM mcr.microsoft.com/dotnet/runtime:7.0-alpine AS final
WORKDIR /app

# 1. Implement Security Best Practice: Create and switch to a non-root user
# This user will run the application and has minimal privileges.
RUN addgroup --system appgroup && adduser -S appuser -G appgroup
USER appuser

# 2. Copy the final published output from the 'publish' stage
COPY --from=publish /app/publish .

# The application is executed by the .NET runtime.
# The entrypoint is the Worker.dll which contains the compiled application.
ENTRYPOINT ["dotnet", "Worker.dll"]